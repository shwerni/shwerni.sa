"use server";

// phone
const phones = [
  "201222166530",
  "966503071504",
  "966542268030",
  "966599930062",
  "966505955036",
  "966558835690",
  "966539220400",
  "966505429969",
  "966503579773",
  "966508090785",
  "966533223959",
  "966508383820",
  "966549390915",
  "966597425253",
  "966558805333",
  "966544397856",
  "966535855507",
  "966543432485",
  "966555323378",
  "966590757333",
  "966590983347",
  "966555277685",
  "966505778502",
  "966590983377",
  "966596377573",
  "966545554588",
  "966534796927",
  "966540549625",
  "966545552115",
  "966548525340",
  "201065217785",
  "966533224791",
  "966506501440",
  "966543397541",
  "966501959613",
  "966539631742",
  "966559066699",
  "966501556166",
  "966566667636",
  "966553666998",
  "966544175245",
  "966506128882",
  "966543923440",
  "966506321139",
  "966548171733",
  "966548592574",
  "966503019310",
  "966505351174",
  "966550785090",
  "966544145245",
  "966532447466",
  "966557133836",
  "966551277338",
  "966536343130",
  "966502052078",
  "966550596333",
  "966544694625",
  "966551153888",
  "966551153885",
  "966559203030",
  "966591123281",
  "966566861417",
  "966558583163",
  "966555213221",
  "966506651812",
  "966534333636",
  "966533335281",
  "966530731838",
  "966505699950",
  "966555747108",
  "971555200510",
  "966554668288",
  "966554247744",
  "966569695015",
  "966565145538",
  "966555569094",
  "966547176362",
  "966500620128",
  "966540429004",
  "966505399665",
  "966503833896",
  "966502727220",
  "966506500161",
  "966555335405",
  "966559993960",
  "966565070447",
  "966549885081",
  "966552121677",
  "966568901372",
  "966550561011",
  "966552584574",
  "974005790009",
  "966541690053",
  "965999930360",
  "966508043312",
  "966544533633",
  "966549958486",
  "699503833896",
  "966553053588",
  "966531066045",
  "966537474111",
  "201222166530",
  "966544537073",
  "966568421655",
  "966531967608",
  "966505149208",
  "966551854372",
  "966550510120",
  "966553440095",
  "966505990339",
  "966565419686",
  "966565584551",
  "966565441426",
  "966538291826",
  "966556521657",
  "966551979116",
  "966504447091",
  "966590900079",
  "966558644178",
  "966500118242",
  "966555272477",
  "966550152242",
  "966555022838",
  "966555965256",
  "966547230073",
  "966556660660",
  "966506265633",
  "966559984504",
  "966548130090",
  "966598000224",
  "966533274017",
  "966501999690",
  "966559737181",
  "966533999740",
  "966534272785",
  "966565791314",
  "966500105585",
  "966556453863",
  "966595951631",
  "966507956743",
  "966531449661",
  "966549903908",
  "966503006802",
  "966554380151",
  "966505422489",
  "971501231122",
  "966544307444",
  "966593082074",
  "966555121642",
  "966569005776",
  "966593439667",
  "966567786195",
  "966503233406",
  "966506157077",
  "966590600152",
  "966543663515",
  "966542732023",
  "097334888855",
  "966555338638",
  "966547799120",
  "966580514004",
  "966563348748",
  "966531282899",
  "966580514005",
  "966590007381",
  "966570477744",
  "966556862330",
  "966551837057",
  "966500021380",
  "966551577150",
  "966537771712",
  "966566611752",
  "974330181810",
  "966502327814",
  "966547232800",
  "966546002060",
  "966547823338",
  "966581110747",
  "966504877611",
  "966566713131",
  "966501645911",
  "966562181962",
  "966534921292",
  "966540806030",
  "966547732543",
  "966555721444",
  "966541810603",
  "966555959926",
  "966500722755",
  "966546155929",
  "966541885551",
  "966558398868",
  "966542747101",
  "966553399234",
  "966502748205",
  "966530390065",
  "966537074324",
  "966565361150",
  "966501066080",
  "966533335164",
  "966555205804",
  "966558404898",
  "966501205550",
  "966552202085",
  "966557844615",
  "966581118975",
  "966505559957",
  "966538038953",
  "966507689907",
  "966566774599",
  "971565224414",
  "966538830009",
  "966591353826",
  "966538890012",
  "966554669232",
  "966505248329",
  "966503815554",
  "966569401236",
  "966552206150",
  "966508947481",
  "966550467451",
  "966505615486",
  "966544150950",
  "966569900484",
  "966539784819",
  "966558988223",
  "966555333229",
  "966548944278",
  "966532904977",
  "966502191073",
  "966509021909",
  "966504612099",
  "966549312557",
  "966551448088",
  "966563003062",
  "966546372040",
  "966504476958",
  "966537878026",
  "971569405805",
  "966533804728",
  "966591117741",
  "966555591987",
  "966504460931",
  "966505333903",
  "966540331135",
  "966558809432",
  "966551990123",
  "966570141280",
  "966569950181",
  "966599085529",
  "966506832418",
  "966504613005",
  "966565142442",
  "966505349139",
  "966597226923",
  "966508048521",
  "966509308027",
  "966558529000",
  "966590776311",
  "966500385027",
  "966556314154",
  "966533112690",
  "966540880077",
  "966535055500",
  "966556314944",
  "966509888995",
  "966566127788",
  "966549788804",
  "966505120654",
  "966548058088",
  "966535813034",
  "966594139111",
  "966549007494",
  "966504227564",
  "966536983553",
  "966506363102",
  "966542837377",
  "966556662038",
  "966504148529",
  "966541062040",
  "966537555380",
  "966596269990",
  "966558185367",
  "966550768770",
  "966500051960",
  "966544181777",
  "966500081804",
  "966563166035",
  "966559983884",
  "966565660077",
  "966504699228",
  "966544174177",
  "966556315053",
  "966503293892",
  "966540208065",
  "966556635560",
  "966597921424",
  "966501230999",
  "966545908297",
  "966540033059",
  "966554492266",
];

// delay
const delay = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

// Async function to send message
async function sendMessage(phone: string) {
  const body = {
    messaging_product: "whatsapp",
    to: phone,
    type: "template",
    template: {
      name: "temporary_message",
      language: {
        code: "ar",
      },
      // components: [
      // {
      //   type: "header",
      //   parameters: [
      //     {
      //       type: "image",
      //       image: {
      //         link: "https://huqzhdqiy3.ufs.sh/f/8ARlb1WnaI71XzYdLvKMaDi5lKY2zeBw7rRs6mQF4AbtCfHn",
      //       },
      //     },
      //   ],
      // },
      // {
      //   type: "body",
      //   parameters: [
      //     {
      //       type: "text",
      //       text: "Ø²ÙŠØ§Ø¯ Ø¬Ù…Ø§Ù„",
      //     },
      //   ],
      // },
      // {
      //   type: "button",
      //   sub_type: "copy_code",
      //   index: "1",
      //   parameters: [
      //     {
      //       type: "coupon_code",
      //       coupon_code: "THANKU",
      //     },
      //   ],
      // },
      // {
      //   type: "button",
      //   sub_type: "flow",
      //   index: "0",
      // },
      // ],
    },
  };

  try {
    const res = await fetch(process.env.WHATSAPP_URL as string, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.WHATSAPP_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });

    // parsing the response
    const data = await res.json().catch(() => null);

    // error
    if (!res.ok) {
      console.error(
        `âŒ [${phone}] Request failed: ${res.status} ${res.statusText}`,
        data || ""
      );
      // return
      return { success: false };
    }

    // success
    console.log(`âœ… [${phone}] Message sent successfully`);

    // return
    return { success: true };
  } catch (err: any) {
    console.error(`ğŸ”¥ [${phone}] Network or fetch error:`, err.message);
    // return
    return { success: false };
  }
}

// Send all in parallel
export async function sendBulkMessage() {
  // start
  console.log("ğŸš€ sent bulk WhatsApp message....");
  const startTime = Date.now();

  // size
  const size = 50;

  // send results
  let results: any[] = [];

  // handle limit rate
  for (let i = 0; i < phones.length; i += size) {
    const batch = phones.slice(i, i + size);

    await Promise.allSettled(batch.map(sendMessage));

    await delay(1100);
  }

  // success
  const success = results.filter(
    (r) => r.status === "fulfilled" && r.value.success
  ).length;

  // failed
  const failed = results.length - success;

  // summary
  console.log("ğŸ“Š Summary:");
  console.log(`  âœ… Success: ${success}`);
  console.log(`  âŒ Failed: ${failed}`);
  console.log(`  â±ï¸ Duration: ${(Date.now() - startTime) / 1000}s`);

  // log details
  // results.forEach((r) => {
  //   if (r.status === "fulfilled") {
  //     if (r.value.success) {
  //       console.log(`   â†’ ${r.value.phone}: âœ… Success`);
  //     } else {
  //       console.log(
  //         `   â†’ ${r.value.phone}: âŒ Failed - ${
  //           r.value.error || "Unknown error"
  //         }`
  //       );
  //     }
  //   } else {
  //     console.log(`   â†’ Promise rejected: ${r.reason}`);
  //   }
  // });

  console.log("ğŸ¯ Bulk sending complete.");
}
